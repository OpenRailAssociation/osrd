CREATE TABLE infra_layer_neutral_sign (
    id int8 PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    obj_id varchar(255) NOT NULL,
    geographic geometry(point, 3857) NOT NULL,
    schematic geometry(point, 3857) NOT NULL,
    angle_geo float8 NOT NULL,
    angle_sch float8 NOT NULL,
    data jsonb NOT NULL,
    infra_id int8 NOT NULL REFERENCES infra(id) ON DELETE CASCADE
);
CREATE INDEX infra_layer_neutral_sign_geographic ON infra_layer_neutral_sign USING gist (geographic);
CREATE INDEX infra_layer_neutral_sign_schematic ON infra_layer_neutral_sign USING gist (schematic);
ALTER TABLE infra_layer_psl_sign
ADD COLUMN angle_geo float8 DEFAULT 0;
ALTER TABLE infra_layer_psl_sign
ADD COLUMN angle_sch float8 DEFAULT 0;
UPDATE infra_object_speed_section
SET data = jsonb_set(
        jsonb_set(
            data,
            '{extensions,psl_sncf,z}',
            (data->'extensions'->'psl_sncf'->'z') - 'angle_geo' - 'angle_sch'
        ),
        '{extensions,psl_sncf,z,direction}',
        '"START_TO_STOP"'
    )
WHERE data->'extensions'->'psl_sncf'->'z' IS NOT NULL;
UPDATE infra_object_speed_section
SET data = jsonb_set(
        data,
        '{extensions,psl_sncf,r}',
        (
            SELECT jsonb_agg(
                    jsonb_set(
                        element - 'angle_geo' - 'angle_sch',
                        '{direction}',
                        '"START_TO_STOP"'
                    )
                )
            FROM jsonb_array_elements(data->'extensions'->'psl_sncf'->'r') AS element
        )
    )
WHERE data->'extensions'->'psl_sncf'->'r' IS NOT NULL
    AND data->'extensions'->'psl_sncf'->'r' != '[]'::jsonb;
UPDATE infra_object_speed_section
SET data = jsonb_set(
        data,
        '{extensions,psl_sncf,announcement}',
        (
            SELECT jsonb_agg(
                    jsonb_set(
                        element - 'angle_geo' - 'angle_sch',
                        '{direction}',
                        '"START_TO_STOP"'
                    )
                )
            FROM jsonb_array_elements(data->'extensions'->'psl_sncf'->'announcement') AS element
        )
    )
WHERE data->'extensions'->'psl_sncf'->'announcement' IS NOT NULL
    AND data->'extensions'->'psl_sncf'->'announcement' != '[]'::jsonb;
UPDATE infra
SET railjson_version = '3.4.9';
