openapi: 3.0.2
info:
  title: OSRD Editoast
  description: OSRD Edition service description
  version: 0.1.0

tags:
  - name: infra
    description: Infra
  - name: routes
    description: Operations related to infra routes
  - name: timetable
    description: Timetable
  - name: pathfinding
    description: Pathfinding operations
  - name: layers
    description: Map layers
  - name: electrical_profiles
    description: Electrical profiles
  - name: train_schedule
    description: Train Schedule

paths:
  /search/:
    post:
      summary: Generic search endpoint
      parameters:
        - in: query
          name: page_size
          schema:
            type: integer
          description: number of results
      requestBody:
        description: Search query
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                object:
                  type: string
                  example: "operationalpoint"
                query:
                  $ref: "#/components/schemas/SearchQuery"
                page:
                  type: integer
                  default: 1
                page_size:
                  type: integer
                  default: 25
      responses:
        200:
          description: Search results, the structure of the returned objects depend on their type
          content:
            application/json:
              schema:
                type: array
                items:
                  oneOf:
                    - $ref: "#/components/schemas/SearchTrackResult"
                    - $ref: "#/components/schemas/SearchOperationalPointResult"
                    - $ref: "#/components/schemas/SearchSignalResult"
                    - $ref: "#/components/schemas/SearchStudyResult"
                    - $ref: "#/components/schemas/SearchProjectResult"
                    - $ref: "#/components/schemas/SearchScenarioResult"

  /layers/layer/{layer_slug}/mvt/{view_slug}/:
    get:
      tags:
        - layers
      summary: Mvt View Metadata
      parameters:
        - required: true
          schema:
            title: Layer Slug
            type: string
          name: layer_slug
          in: path
        - required: true
          schema:
            title: View Slug
            type: string
          name: view_slug
          in: path
        - required: true
          schema:
            title: Infra id
            type: integer
          name: infra
          in: query
      responses:
        200:
          description: Successful Response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ViewMetadata"

  /layers/tile/{layer_slug}/{view_slug}/{z}/{x}/{y}/:
    get:
      tags:
        - layers
      summary: Mvt tile from the cache or the database, cache data in redis if needed
      parameters:
        - required: true
          schema:
            title: Layer Slug
            type: string
          name: layer_slug
          in: path
        - required: true
          schema:
            title: View Slug
            type: string
          name: view_slug
          in: path
        - required: true
          schema:
            title: Z
            type: integer
          name: z
          in: path
        - required: true
          schema:
            title: X
            type: integer
          name: x
          in: path
        - required: true
          schema:
            title: Y
            type: integer
          name: y
          in: path
        - required: true
          schema:
            title: Infra
            type: integer
          name: infra
          in: query
      responses:
        200:
          description: Successful Response
          content:
            application/x-octet-stream:
              schema:
                type: string

  /electrical_profile_set/:
    get:
      tags:
        - electrical_profiles
      summary: Retrieve the list of ids and names of electrical profile sets available
      responses:
        200:
          description: The list of ids and names of electrical profile sets available
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  required:
                    - id
                    - name
                  properties:
                    id:
                      type: integer
                    name:
                      type: string
                      example: "France 2023"

    post:
      tags:
        - electrical_profiles
      summary: import a new electrical profile set
      parameters:
        - in: query
          name: name
          required: true
          schema:
            type: string
      responses:
        200:
          description: The list of ids and names of electrical profile sets available
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ElectricalProfile"

  /electrical_profile_set/{id}/:
    get:
      tags:
        - electrical_profiles
      summary: Retrieve the set of electrical profiles with the given id
      parameters:
        - in: path
          name: id
          schema:
            type: integer
          description: Electrical profile set ID
          required: true
      responses:
        200:
          description: The list of electrical profiles in the set
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ElectricalProfile"

  /electrical_profile_set/{id}/level_order/:
    get:
      tags:
        - electrical_profiles
      summary: Retrieve the order of strength of the electrical profiles in the set with the given id
      parameters:
        - in: path
          name: id
          schema:
            type: integer
          description: Electrical profile set ID
          required: true
      responses:
        200:
          description: A dictionary mapping catenary modes to a list of electrical profiles ordered by decreasing strength
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: array
                  items:
                    type: string
                example:
                  "1500": ["A", "B", "C"]
                  "25000": ["25000", "22500", "20000"]

  /documents/{key}/:
    get:
      tags:
        - documents
      summary: Retrieve a document binary content
      parameters:
        - in: path
          name: key
          schema:
            type: integer
          description: A key identifying the document
          required: true
      responses:
        200:
          description: A document of any type (can be an image, a pdf...)
    delete:
      tags:
        - documents
      summary: Delete a document
      parameters:
        - in: path
          name: key
          schema:
            type: integer
          description: A key identifying the document
          required: true
      responses:
        204:
          description: No content

  /documents/:
    post:
      tags:
        - documents
      summary: Add a document
      responses:
        201:
          description: The key of the added document
          content:
            application/json:
              schema:
                type: object
                properties:
                  document_key:
                    type: integer
                    example: 42

  /light_rolling_stock/:
    get:
      tags:
        - rolling_stock
      summary: Paginated list of rolling stock with a lighter response
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number
        - in: query
          name: page_size
          schema:
            type: integer
            maximum: 10000
            minimum: 1
            default: 100
          description: Number of elements by page
      responses:
        200:
          description: The rolling stock list
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: number
                  next: {}
                  previous: {}
                  results:
                    type: array
                    items:
                      $ref: "#/components/schemas/LightRollingStock"
                required:
                  - results

  /light_rolling_stock/{id}/:
    get:
      tags:
        - rolling_stock
      summary: Retrieve a rolling stock's light representation
      parameters:
        - in: path
          name: id
          schema:
            type: integer
          description: Rolling Stock ID
          required: true
      responses:
        200:
          description: The rolling stock with their simplified effort curves
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LightRollingStock"

  /pathfinding/:
    post:
      summary: Create a Path
      requestBody:
        description: Path information
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PathQuery"
      responses:
        201:
          description: The created Path
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Path"

  /pathfinding/{id}/:
    get:
      tags:
        - pathfinding
      summary: Retrieve a Path
      parameters:
        - in: path
          name: id
          schema: { type: integer }
          description: Path ID
          required: true
      responses:
        200:
          description: The retrieved path
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Path"
    put:
      tags:
        - pathfinding
      summary: Update a path
      parameters:
        - in: path
          name: id
          schema: { type: integer }
          description: Path ID
          required: true
      requestBody:
        description: Updated Path
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PathQuery"
      responses:
        200:
          description: The updated path
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Path"
    delete:
      tags:
        - pathfinding
      summary: Delete a path
      parameters:
        - in: path
          name: id
          schema:
            type: integer
          description: Path ID
          required: true
      responses:
        204:
          description: No content

  /rolling_stock/:
    post:
      tags:
        - rolling_stock
      summary: Create a rolling stock
      parameters:
        - in: query
          name: locked
          description: whether or not the rolling_stock can be edited/deleted.
          schema:
            default: false
            type: boolean
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RollingStockUpsertPayload"
      responses:
        200:
          description: The created rolling stock
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RollingStock"

  /rolling_stock/{id}/:
    get:
      tags:
        - rolling_stock
      summary: Retrieve a rolling stock
      parameters:
        - in: path
          name: id
          schema:
            type: integer
          description: Rolling Stock ID
          required: true
      responses:
        200:
          description: The rolling stock information
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RollingStock"
    patch:
      tags:
        - rolling_stock
      summary: Patch a rolling stock
      parameters:
        - in: path
          name: id
          schema:
            type: integer
          description: Rolling Stock ID
          required: true
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RollingStockUpsertPayload"
      responses:
        200:
          description: The updated rolling stock
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RollingStock"
    delete:
      tags:
        - rolling_stock
      summary: Delete a rolling_stock and all entities linked to it
      parameters:
        - in: path
          name: id
          schema:
            type: integer
          description: rolling_stock id
          required: true
        - in: query
          name: force
          description: force the deletion even if it’s used
          schema:
            type: boolean
            default: false
      responses:
        204:
          description: No content
        409:
          description: Rolling stock is used in a train schedule.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RollingStockUsage"

  /rolling_stock/{id}/locked/:
    patch:
      tags:
        - rolling_stock
      summary: Update rolling_stock locked field
      parameters:
        - in: path
          name: id
          description: Rolling_stock id
          required: true
          schema:
            type: integer
      requestBody:
        description: New locked value
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                locked:
                  type: boolean
      responses:
        204:
          description: No content
        404:
          description: Not found

  /rolling_stock/{id}/livery/:
    post:
      tags:
        - rolling_stock
        - rolling_stock_livery
      summary: Create a rolling stock livery
      parameters:
        - in: path
          name: id
          schema:
            type: integer
          description: Rolling Stock ID
          required: true
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                name:
                  type: string
                images:
                  type: array
                  items:
                    type: string
                    format: binary
      responses:
        200:
          description: The rolling stock livery
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RollingStockLivery"

  /projects/:
    post:
      tags:
        - projects
      summary: Create a new project
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProjectCreateRequest"
      responses:
        201:
          description: The created project
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProjectResult"
    get:
      tags:
        - projects
      summary: Paginated list of projects
      parameters:
        - in: query
          name: ordering
          schema:
            type: string
            enum:
              [
                "NameAsc",
                "NameDesc",
                "CreationDateAsc",
                "CreationDateDesc",
                "LastModifiedAsc",
                "LastModifiedDesc",
              ]
        - in: query
          name: name
          schema:
            type: string
          description: Filter projects by name
        - in: query
          name: description
          schema:
            type: string
          description: Filter projects by description
        - in: query
          name: tags
          schema:
            type: string
          description: Filter projects by tags
        - in: query
          name: page
          schema:
            type: integer
            minimum: 0
          description: Page number
        - in: query
          name: page_size
          schema:
            type: integer
            maximum: 10000
            minimum: 1
            default: 100
          description: Number of elements by page
      responses:
        200:
          description: the project list
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: number
                  next: {}
                  previous: {}
                  results:
                    type: array
                    items:
                      $ref: "#/components/schemas/ProjectResult"

  /projects/{project_id}/:
    get:
      tags:
        - projects
      summary: Retrieve a project
      parameters:
        - in: path
          name: project_id
          schema:
            type: integer
          description: project id you want to retrieve
          required: true
      responses:
        200:
          description: The project info
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProjectResult"
    patch:
      tags:
        - projects
      summary: Update a project
      parameters:
        - in: path
          name: project_id
          schema:
            type: integer
          description: project id you want to update
          required: true
      requestBody:
        description: The fields you want to update
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProjectPatchRequest"
      responses:
        200:
          description: The project updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProjectResult"
    delete:
      tags:
        - projects
      summary: delete a project
      parameters:
        - in: path
          name: project_id
          schema:
            type: integer
          description: project id you want to delete
          required: true
      responses:
        204:
          description: No content

  /timetable/{id}/:
    get:
      tags:
        - timetable
      summary: Retrieve a timetable and its train schedules
      parameters:
        - in: path
          name: id
          schema:
            type: integer
          description: Timetable ID
          required: true
      responses:
        200:
          description: The timetable content
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TimetableWithSchedulesDetails"
    post:
      description: Import a timetable
      parameters:
      - description: Timetable id
        in: path
        name: id
        required: true
        schema:
          format: int64
          minimum: 0
          type: integer
      requestBody:
        content:
          application/json:
            schema:
              items:
                $ref: '#/components/schemas/TimetableImportItem'
              type: array
        description: ''
        required: true
      responses:
        '204':
          description: Timetable was successfully imported
      summary: Import a timetable
      tags:
      - timetable

  /timetable/{id}/conflicts/:
    get:
      tags:
        - timetable
      summary: Retrieve all conflicts for a specific timetable
      parameters:
        - in: path
          name: id
          schema:
            type: integer
          description: Timetable ID
          required: true
      responses:
        200:
          description: The timetable conflicts content
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    train_ids:
                      type: array
                      items:
                        type: number
                    train_names:
                      type: array
                      items:
                        type: string
                    start_time:
                      type: string
                    end_time:
                      type: string
                    conflict_type:
                      type: string
                  required:
                    [
                      train_ids,
                      train_names,
                      start_time,
                      end_time,
                      conflict_type,
                    ]

  /projects/{project_id}/studies/:
    post:
      tags:
        - studies
      summary: Create a new operational study
      parameters:
        - in: path
          name: project_id
          schema:
            type: integer
          required: true
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StudyUpsertRequest"
      responses:
        201:
          description: The created operational study
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StudyResult"
    get:
      tags:
        - studies
      summary: Paginated list of operational studies
      parameters:
        - in: path
          name: project_id
          schema:
            type: integer
          required: true
        - in: query
          name: ordering
          schema:
            type: string
            enum:
              [
                "NameAsc",
                "NameDesc",
                "CreationDateAsc",
                "CreationDateDesc",
                "LastModifiedAsc",
                "LastModifiedDesc",
              ]
        - in: query
          name: name
          schema:
            type: string
          description: Filter operational studies by name
        - in: query
          name: description
          schema:
            type: string
          description: Filter operational studies by description
        - in: query
          name: tags
          schema:
            type: string
          description: Filter operational studies by tags
        - in: query
          name: page
          schema:
            type: integer
            minimum: 0
          description: Page number
        - in: query
          name: page_size
          schema:
            type: integer
            maximum: 10000
            minimum: 1
            default: 100
          description: Number of elements by page
      responses:
        200:
          description: the studies list
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: number
                  next: {}
                  previous: {}
                  results:
                    type: array
                    items:
                      $ref: "#/components/schemas/StudyResult"

  /projects/{project_id}/studies/{study_id}/:
    get:
      tags:
        - studies
      summary: Retrieve an operational study
      parameters:
        - in: path
          name: project_id
          schema:
            type: integer
          description: project id refered to the operational study
          required: true
        - in: path
          required: true
          name: study_id
          schema:
            type: integer
          description: study id you want to retrieve
      responses:
        200:
          description: The operational study info
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StudyResult"
    patch:
      tags:
        - studies
      summary: update an operational study
      parameters:
        - in: path
          name: project_id
          schema:
            type: integer
          description: project id refered to the study
          required: true
        - in: path
          required: true
          name: study_id
          schema:
            type: integer
          description: study id you want to retrieve
      requestBody:
        description: The fields you want to update
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StudyUpsertRequest"
      responses:
        200:
          description: The operational study updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StudyResult"
    delete:
      tags:
        - studies
      summary: delete an operational study
      parameters:
        - in: path
          name: project_id
          schema:
            type: integer
          description: project id refered to the operational study
          required: true
        - in: path
          required: true
          name: study_id
          schema:
            type: integer
          description: study id you want to delete
      responses:
        204:
          description: No content

  /projects/{project_id}/studies/{study_id}/scenarios/:
    post:
      tags:
        - scenarios
      summary: Create a new scenario
      parameters:
        - in: path
          name: project_id
          schema:
            type: integer
          required: true
        - in: path
          required: true
          name: study_id
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ScenarioRequest"
      responses:
        201:
          description: The created scenario
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ScenarioResult"
    get:
      tags:
        - scenarios
      summary: Paginated list of scenarios
      parameters:
        - in: path
          name: project_id
          schema:
            type: integer
          required: true
        - in: path
          required: true
          name: study_id
          schema:
            type: integer
        - in: query
          name: ordering
          schema:
            type: string
            enum:
              [
                "NameAsc",
                "NameDesc",
                "CreationDateAsc",
                "CreationDateDesc",
                "LastModifiedAsc",
                "LastModifiedDesc",
              ]
        - in: query
          name: page
          schema:
            type: integer
            minimum: 0
          description: Page number
        - in: query
          name: page_size
          schema:
            type: integer
            maximum: 10000
            minimum: 1
            default: 100
          description: Number of elements by page
      responses:
        200:
          description: list of scenarios
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: number
                  next: {}
                  previous: {}
                  results:
                    type: array
                    items:
                      $ref: "#/components/schemas/ScenarioListResult"

  /projects/{project_id}/studies/{study_id}/scenarios/{scenario_id}/:
    get:
      tags:
        - scenarios
      summary: Retrieve a scenario
      parameters:
        - in: path
          name: project_id
          schema:
            type: integer
          description: project id refered to the scenario
          required: true
        - in: path
          required: true
          name: study_id
          schema:
            type: integer
        - in: path
          required: true
          name: scenario_id
          schema:
            type: integer
          description: scenario id you want to retrieve
      responses:
        200:
          description: The operational study info
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ScenarioResult"
    delete:
      tags:
        - scenarios
      summary: delete a scenario
      parameters:
        - in: path
          name: project_id
          schema:
            type: integer
          description: project id refered to the scenario
          required: true
        - in: path
          required: true
          name: study_id
          schema:
            type: integer
          description: study id refered to the scenario
        - in: path
          required: true
          name: scenario_id
          schema:
            type: integer
          description: scenario id you want to delete
      responses:
        204:
          description: No content
    patch:
      tags:
        - scenarios
      summary: update a scenario
      parameters:
        - in: path
          name: project_id
          schema:
            type: integer
          description: project id refered to the scenario
          required: true
        - in: path
          required: true
          name: study_id
          schema:
            type: integer
          description: study refered to the scenario
        - in: path
          required: true
          name: scenario_id
          schema:
            type: integer
          description: scenario you want to update
      requestBody:
        description: The fields you want to update
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ScenarioPatchRequest"
      responses:
        200:
          description: The scenario updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ScenarioResult"

  /pathfinding/{path_id}/catenaries/:
    get:
      tags:
        - infra
      summary: Retrieve the modes of catenaries along a path
      parameters:
        - in: path
          name: path_id
          schema:
            type: integer
          description: The path's id
          required: true
      responses:
        200:
          description: A list of ranges associated to catenary modes. When a catenary overlapping another is found, a warning is added to the list.
          content:
            application/json:
              schema:
                type: object
                properties:
                  catenary_ranges:
                    type: array
                    items:
                      $ref: "#/components/schemas/CatenaryRange"
                  warnings:
                    type: array
                    items:
                      type: object
                      properties:
                        type:
                          type: string
                          enum: ["CatenaryOverlap"]
                        catenary_id:
                          type: string
                        overlapping_ranges:
                          type: array
                          items:
                            $ref: "#/components/schemas/TrackRange"
                      required: [type, catenary_id, overlapping_ranges]
                required: [catenary_ranges, warnings]

  /train_schedule/{id}/:
    get:
      tags:
        - train_schedule
      summary: Retrieve a train schedule
      parameters:
        - in: path
          name: id
          schema:
            type: integer
          description: Train schedule ID
          required: true
      responses:
        200:
          description: The train schedule info
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TrainSchedule"
    delete:
      tags:
        - train_schedule
      summary: Delete a train schedule and its result
      parameters:
        - in: path
          name: id
          schema:
            type: integer
          description: Train schedule ID
          required: true
      responses:
        204:
          description: No content

  /train_schedule/{id}/result/:
    get:
      tags:
        - train_schedule
      summary: Retrieve a simulation result
      parameters:
        - in: path
          name: id
          schema:
            type: integer
          description: Train schedule ID
          required: true
        - in: query
          name: path_id
          schema:
            type: integer
          description: Path id used to project the train path
          required: true
      responses:
        200:
          description: The train schedule result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SimulationReport"

  /train_schedule/:
    delete:
      tags:
        - train_schedule
      summary: Delete multiple train schedule
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ids
              properties:
                ids:
                  type: array
                  items:
                    type: integer
      responses:
        204:
          description: No content

    patch:
      tags:
        - train_schedule
      summary: Update train schedules and run a simulation accordingly
      requestBody:
        description: A list of changes. Each changeset contains the corresponding train id
        content:
          application/json:
            schema:
              type: array
              minimum: 1
              items:
                $ref: "#/components/schemas/TrainSchedulePatch"
        required: true
      responses:
        200:
          description: The train schedule was updated successfully

  /train_schedule/results/:
    get:
      tags:
        - train_schedule
      summary: Retrieve the simulation result of multiple train schedules of the timetable
      parameters:
        - in: query
          name: path_id
          schema:
            type: integer
          description: Path id used to project the train path
          required: true
        - in: query
          name: timetable_id
          schema:
            type: string
          description: Timetable id
          required: true
      responses:
        200:
          description: The train schedules results
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/SimulationReport"

  /train_schedule/standalone_simulation/:
    post:
      tags:
        - train_schedule
      summary: Create a batch of train schedule and run simulations accordingly
      requestBody:
        description: The list of train schedules to simulate
        content:
          application/json:
            schema:
              type: object
              required: [timetable, path, schedules]
              properties:
                timetable:
                  type: integer
                path:
                  type: integer
                schedules:
                  type: array
                  minItems: 1
                  items:
                    $ref: "#/components/schemas/TrainScheduleBatchItem"
        required: true
      responses:
        201:
          description: The ids of the train_schedules created
          content:
            application/json:
              schema:
                type: array
                minItems: 1
                items:
                  type: number
                  format: integer

  /stdcm/:
    post:
      tags:
        - stdcm
      summary: Find a stdcm and return a simulation result
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
                [
                  infra_id,
                  timetable_id,
                  steps,
                  rolling_stocks,
                  rolling_stock_id,
                  comfort,
                  standard_allowance,
                ]
              properties:
                infra_id:
                  type: integer
                timetable_id:
                  type: integer
                  description: timetable ID
                start_time:
                  type: number
                  format: double
                end_time:
                  type: number
                  format: double
                steps:
                  type: array
                  minItems: 2
                  items:
                    type: object
                    properties:
                      duration:
                        type: number
                        format: float
                      waypoints:
                        $ref: "#/components/schemas/Waypoint"
                    required: [duration, waypoints]
                rolling_stocks:
                  type: array
                  items:
                    type: integer
                rolling_stock_id:
                  type: integer
                comfort:
                  $ref: "#/components/schemas/Comfort"
                maximum_departure_delay:
                  type: number
                  format: double
                  description: By how long we can shift the departure time (s). Defaults to 2h if unspecified.
                maximum_run_time:
                  type: number
                  format: double
                  description: |
                    Specifies how long the total run time can be in seconds.
                    Defaults to 43200s if unspecified, meaning that the result can't exceed 12h.
                speed_limit_tags:
                  type: string
                  description: Train category for speed limits
                margin_before:
                  type: number
                  format: double
                  description: |
                    Margin of x seconds before the train passage, which means that the path used by the train should
                    be free and available at least x seconds before its passage.
                margin_after:
                  type: number
                  format: double
                  description: |
                    Margin of y seconds after the train passage, which means that the path used by the train should
                    be free and available at least y seconds after its passage.
                standard_allowance:
                  $ref: "#/components/schemas/AllowanceValue"
      responses:
        200:
          description: Simulation result
          content:
            application/json:
              schema:
                oneOf:
                  - properties:
                      simulation:
                        $ref: "#/components/schemas/SimulationReport"
                      path:
                        $ref: "#/components/schemas/Path"
                    required: [simulation, path]
                  - type: object
                    properties:
                      error:
                        type: string
                        description: Error message
                        example: No path could be found
        400:
          description: The request body is invalid

  /version/core/:
    get:
      responses:
        200:
          description: Return the core service version
          content:
            application/json:
              schema:
                type: object
                properties:
                  git_describe:
                    type: string
                    nullable: true
                required:
                  - git_describe

components:
  schemas:
    Battery:
      description: energy source for a rolling stock representing a battery
      type: object
      required:
        [
          energy_source_type,
          max_input_power,
          max_output_power,
          energy_storage,
          efficiency,
        ]
      properties:
        energy_source_type:
          type: string
          enum: ["Battery"]
        max_input_power:
          $ref: "#/components/schemas/SpeedDependantPower"
        max_output_power:
          $ref: "#/components/schemas/SpeedDependantPower"
        energy_storage:
          $ref: "#/components/schemas/EnergyStorage"
        efficiency:
          type: number
          format: float
          minimum: 0
          maximum: 1

    Catenary:
      description: energy source for a rolling stock representing a catenary
      type: object
      required:
        [energy_source_type, max_input_power, max_output_power, efficiency]
      properties:
        energy_source_type:
          type: string
          enum: ["Catenary"]
        max_input_power:
          $ref: "#/components/schemas/SpeedDependantPower"
        max_output_power:
          $ref: "#/components/schemas/SpeedDependantPower"
        efficiency:
          type: number
          format: float
          minimum: 0
          maximum: 1

    Comfort:
      description: Train comfort that will be used for the simulation
      type: string
      enum: ["AC", "HEATING", "STANDARD"]
      default: "STANDARD"

    ConditionalEffortCurve:
      type: object
      properties:
        cond:
          type: object
          nullable: true
          properties:
            comfort:
              $ref: "#/components/schemas/Comfort"
              nullable: true
            electrical_profile_level:
              type: string
              nullable: true
            power_restriction_code:
              type: string
              nullable: true
        curve:
          $ref: "#/components/schemas/EffortCurve"

    EffortCurve:
      type: object
      properties:
        speeds:
          type: array
          example: [0.0, 2.958, 46.719]
          minItems: 2
          items:
            type: number
            format: float
        max_efforts:
          type: array
          example: [23500.0, 23200.0, 21200.0]
          minItems: 2
          items:
            type: number
            format: float

    EnergySource:
      description: enery source of a rolling stock
      oneOf:
        - $ref: "#/components/schemas/Catenary"
        - $ref: "#/components/schemas/PowerPack"
        - $ref: "#/components/schemas/Battery"
      discriminator:
        propertyName: energy_source_type

    EnergyStorage:
      description: energy storage of an energy source (of a rolling stock, can be a electrical battery or a hydrogen/fuel powerPack)
      type: object
      required: [capacity, soc, soc_min, soc_max, refill_law]
      properties:
        capacity:
          type: number
          format: float
        soc:
          type: number
          format: float
          minimum: 0
          maximum: 1
        soc_min:
          type: number
          format: float
          minimum: 0
          maximum: 1
        soc_max:
          type: number
          format: float
          minimum: 0
          maximum: 1
        refill_law:
          description: physical law defining how the storage can be refilled
          nullable: true
          type: object
          properties:
            tau:
              type: number
              format: float
              minimum: 0
            soc_ref:
              type: number
              format: float
              minimum: 0
              maximum: 1
          required: [tau, soc_ref]

    GeoJsonObject:
      type: object
      description: GeoJson format
      properties:
        coordinates:
          type: array
          items:
            type: array
            items: { type: number, format: float }
        type: { type: string }
      required: [coordinates, type]

    GeoJsonPosition:
      type: object
      properties:
        coordinates:
          type: array
          items: { type: number, format: float }
          minItems: 2
          maxItems: 2
        type: { type: string }
      required: [coordinates, type]

    ViewMetadata:
      properties:
        type:
          type: string
          example: vector
        name:
          type: string
          example: track_sections
        promotedId:
          type: object
          example: { track_sections: "id" }
        scheme:
          type: string
          example: "xyz"
        tiles:
          type: array
          items:
            type: string
            example: http://localhost:7070/tile/track_sections/geo/{z}/{x}/{y}/?infra=1
        attribution:
          type: string
        minzoom:
          type: integer
        maxzoom:
          type: integer
          example: 18

    TrackSectionLocation:
      type: object
      description: A track location (track section and offset)
      properties:
        track_section:
          type: string
          description: The track section ID
          example: 61205924-6667-11e3-81ff-01f464e0362d
        offset:
          type: number
          format: float
          description: The offset on the track section
          example: 42.
      required: [track_section, offset]

    TrackRange:
      type: object
      description: Track range
      properties:
        track:
          type: string
          example: 01234567-89ab-cdef-0123-456789abcdef
        begin:
          type: number
          format: float
        end:
          type: number
          format: float
          example: 100

    LightRollingStock:
      allOf:
        - $ref: "#/components/schemas/RollingStockBase"
        - type: object
          properties:
            railjson_version:
              type: string
              example: "3.2"
            id:
              type: number
            liveries:
              type: array
              items:
                $ref: "#/components/schemas/RollingStockLivery"
            effort_curves:
              type: object
              properties:
                default_mode:
                  type: string
                modes:
                  type: object
                  additionalProperties:
                    type: object
                    properties:
                      is_electric:
                        type: boolean
                    required: [is_electric]
              required: [default_mode, modes]
          required: [railjson_version, id, liveries, effort_curves]

    Path:
      properties:
        id: { type: integer }
        owner:
          type: string
          format: uuid
        created:
          type: string
          format: date-time
        length:
          type: number
          format: float
          description: Length of the path
        geographic:
          $ref: "#/components/schemas/GeoJsonObject"
        schematic:
          $ref: "#/components/schemas/GeoJsonObject"
        slopes:
          description: Slopes on the path
          type: array
          items:
            type: object
            properties:
              gradient: { type: number, format: float }
              position: { type: number, format: float }
            required: [gradient, position]
        curves:
          description: Curves on the path
          type: array
          items:
            type: object
            properties:
              radius: { type: number, format: float }
              position: { type: number, format: float }
            required: [radius, position]
        steps:
          type: array
          items:
            $ref: "#/components/schemas/PathStep"
      required:
        [
          id,
          owner,
          created,
          length,
          geographic,
          schematic,
          slopes,
          curves,
          steps,
        ]

    PathQuery:
      type: object
      properties:
        infra:
          type: number
        steps:
          type: array
          minItems: 2
          items:
            type: object
            properties:
              duration: { type: number, format: float }
              waypoints:
                type: array
                items:
                  $ref: "#/components/schemas/PathWaypoint"
            required: [duration, waypoints]
        rolling_stocks:
          description: List of rolling stocks that must be able to use this path
          type: array
          items: { type: integer }
      required: [infra, steps, rolling_stocks]

    PathStep:
      type: object
      properties:
        id: { type: string }
        name: { type: string }
        suggestion: { type: boolean }
        duration: { type: number, format: float }
        path_offset:
          type: number
          format: float
          description: Offset of the step in the path
        location:
          $ref: "#/components/schemas/TrackSectionLocation"
        sch:
          $ref: "#/components/schemas/GeoJsonPosition"
        geo:
          $ref: "#/components/schemas/GeoJsonPosition"
      required: [suggestion, duration, path_offset, location, sch, geo]

    PathWaypoint:
      type: object
      properties:
        track_section:
          description: track section ID of the waypoint
          type: string
        geo_coordinate:
          type: array
          items: { type: number, format: float }
          minItems: 2
          maxItems: 2
        offset:
          type: number
      required: [track_section, geo_cordinate]

    PowerPack:
      description: energy source for a rolling stock representing a power pack (hydrogen, fuel...)
      type: object
      required:
        [
          energy_source_type,
          max_input_power,
          max_output_power,
          energy_storage,
          efficiency,
        ]
      properties:
        energy_source_type:
          type: string
          enum: ["PowerPack"]
        max_input_power:
          $ref: "#/components/schemas/SpeedDependantPower"
        max_output_power:
          $ref: "#/components/schemas/SpeedDependantPower"
        energy_storage:
          $ref: "#/components/schemas/EnergyStorage"
        efficiency:
          type: number
          format: float
          minimum: 0
          maximum: 1

    RollingStock:
      allOf:
        - $ref: "#/components/schemas/RollingStockUpsertPayload"
        - type: object
          properties:
            railjson_version:
              type: string
              example: "3.2"
            id:
              type: number
            liveries:
              type: array
              items:
                $ref: "#/components/schemas/RollingStockLivery"
          required: [railjson_version, id, liveries]

    RollingStockUpsertPayload:
      allOf:
        - $ref: "#/components/schemas/RollingStockBase"
        - type: object
          properties:
            effort_curves:
              type: object
              properties:
                default_mode:
                  type: string
                modes:
                  type: object
                  additionalProperties:
                    type: object
                    properties:
                      curves:
                        type: array
                        items:
                          $ref: "#/components/schemas/ConditionalEffortCurve"
                      default_curve:
                        $ref: "#/components/schemas/EffortCurve"
                      is_electric:
                        type: boolean
                    required: [curves, default_curve, is_electric]
              required: [default_mode, modes]
          required: [effort_curves]

    RollingStockBase:
      properties:
        name:
          type: string
        locked:
          type: boolean
          default: false
          description: Whether the rolling stock can be edited/deleted or not.
        length:
          type: number
          format: float
        max_speed:
          type: number
          format: float
        startup_time:
          type: number
          format: float
        startup_acceleration:
          type: number
          format: float
        comfort_acceleration:
          type: number
          format: float
        gamma:
          type: object
          properties:
            type:
              type: string
              enum: ["CONST", "MAX"]
            value:
              type: number
              format: float
          required: [type, value]
        inertia_coefficient:
          type: number
          format: float
        features:
          type: array
          items:
            type: string
        mass:
          type: number
          format: float
        rolling_resistance:
          type: object
          properties:
            A:
              type: number
            B:
              type: number
            C:
              type: number
            type:
              type: string
              enum: ["davis"]
          required: [A, B, C, type]
        loading_gauge:
          type: string
          enum:
            - "G1"
            - "G2"
            - "GA"
            - "GB"
            - "GB1"
            - "GC"
            - "FR3.3"
            - "FR3.3/GB/G2"
            - "GLOTT"
        base_power_class:
          type: string
          example: "5"
        power_restrictions:
          type: object
          description: Mapping of power restriction code to power class
          additionalProperties:
            type: string
          example:
            "C1US": "4"
            "C2US": "3"
        energy_sources:
          type: array
          items:
            $ref: "#/components/schemas/EnergySource"
        electrical_power_startup_time:
          type: number
          nullable: true
          format: float
          description: The time the train takes before actually using electrical power (in seconds). Is null if the train is not electric.
          example: 5.0
        raise_pantograph_time:
          type: number
          nullable: true
          format: float
          description: The time it takes to raise this train's pantograph in seconds. Is null if the train is not electric.
          example: 15.0
        metadata:
          type: object
          properties:
            detail:
              type: string
            family:
              type: string
            grouping:
              type: string
            number:
              type: string
            reference:
              type: string
            series:
              type: string
            subseries:
              type: string
            type:
              type: string
            unit:
              type: string
          example:
            detail: "BB 7200"
            family: "LOCOMOTIVES"
            grouping: "Locomotives électriques courant continu"
            number: "1"
            reference: "7200"
            series: "BB 7200"
            subseries: "GV"
            type: "Locomotives électriques"
            unit: "US"
          required:
            [
              detail,
              family,
              grouping,
              number,
              reference,
              series,
              subseries,
              type,
              unit,
            ]
      required:
        - name
        - length
        - max_speed
        - startup_time
        - startup_acceleration
        - comfort_acceleration
        - gamma
        - inertia_coefficient
        - features
        - mass
        - rolling_resistance
        - loading_gauge
        - base_power_class
        - power_restrictions
        - metadata
        - energy_sources
        - electrical_power_startup_time
        - raise_pantograph_time

    RollingStockLivery:
      properties:
        id:
          type: number
        name:
          type: string
        compound_image_id:
          type: number
          nullable: true
      required: [id, name, compound_image_id]

    SpeedDependantPower:
      description: power-speed curve (in an energy source)
      type: object
      required: [speeds, powers]
      properties:
        speeds:
          type: array
          items:
            type: number
            format: float
        powers:
          type: array
          items:
            type: number
            format: float

    ElectricalProfile:
      type: object
      properties:
        value:
          type: string
          example: "A"
        power_class:
          type: string
          example: "1"
        track_ranges:
          type: array
          items:
            $ref: "#/components/schemas/TrackRange"

    CatenaryRange:
      type: object
      properties:
        begin:
          type: number
          format: float
          example: 0.0
        end:
          type: number
          format: float
          example: 100.0
        mode:
          type: string
          example: "25000"
      required: [begin, end, mode]

    SearchQuery:
      type: array
      minItems: 1
      nullable: true
      items:
        oneOf:
          - type: boolean
          - type: number
          - type: integer
          - type: string
          - $ref: "#/components/schemas/SearchQuery"
      example:
        [
          "and",
          [
            "or",
            ["search", ["name"], "mich st"],
            ["search", ["trigram"], null],
          ],
          ["=", ["infra_id"], 2],
        ]

    SearchOperationalPointResult:
      required:
        - obj_id
        - name
        - geographic
        - ch
        - schematic
        - trigram
        - track_sections
      properties:
        obj_id:
          type: string
        infra_id:
          type: string
        name:
          type: string
        uic:
          type: integer
        trigram:
          type: string
        ch:
          type: string
        track_sections:
          type: array
          items:
            type: object
            required:
              - track
              - position
            properties:
              track:
                type: string
              position:
                type: integer
        geographic:
          $ref: "#/components/schemas/MultiPoint"
        schematic:
          $ref: "#/components/schemas/MultiPoint"

    SearchTrackResult:
      required:
        - infra_id
        - line_code
        - line_name
      properties:
        infra_id:
          type: integer
        line_code:
          type: integer
        line_name:
          type: string

    SearchSignalResult:
      required:
        - label
        - geographic
        - schematic
        - line_code
        - line_name
      properties:
        label:
          type: string
        infra_id:
          type: integer
        aspects:
          type: array
          items:
            type: string
        systems:
          type: array
          items:
            type: string
        type:
          type: string
        line_code:
          type: integer
        line_name:
          type: string
        geographic:
          $ref: "#/components/schemas/Point"
        schematic:
          $ref: "#/components/schemas/Point"

    SearchProjectResult:
      required:
        - id
        - name
        - description
        - last_modification
      properties:
        id:
          type: integer
        image:
          type: integer
        name:
          type: string
        studies_count:
          type: integer
        description:
          type: string
        last_modification:
          type: string
          format: date-time
        tags:
          type: array

    SearchStudyResult:
      required:
        - id
        - name
        - project_id
        - last_modification
      properties:
        id:
          type: integer
        project_id:
          type: integer
        name:
          type: string
        scenarios_count:
          type: integer
        description:
          type: string
        last_modification:
          type: string
          format: date-time
        tags:
          type: array
          items:
            type: string

    SearchScenarioResult:
      required:
        - id
        - name
        - study_id
        - last_modification
        - infra_id
        - timetable_id
      properties:
        id:
          type: integer
        study_id:
          type: integer
        electrical_profile_set_id:
          type: integer
        name:
          type: string
        trains_count:
          type: integer
        description:
          type: string
        last_modification:
          type: string
          format: date-time
        infra_id:
          type: integer
        infra_name:
          type: string
        tags:
          type: array
          items:
            type: string

    ProjectCreateRequest:
      properties:
        name:
          type: string
          maxLength: 128
        objectives:
          type: string
          maxLength: 4096
          default: ""
        description:
          type: string
          maxLength: 1024
          default: ""
        funders:
          type: string
          maxLength: 1024
          default: ""
        budget:
          type: integer
        image:
          type: integer
          description: The id of the image in the document table
        tags:
          type: array
          items:
            type: string
            maxLength: 255
      required:
        - name

    ProjectPatchRequest:
      properties:
        name:
          type: string
          maxLength: 128
        objectives:
          type: string
          maxLength: 4096
        description:
          type: string
          maxLength: 1024
        funders:
          type: string
          maxLength: 1024
        budget:
          type: integer
        image:
          type: integer
          description: The id of the image in the document table
        tags:
          type: array
          items:
            type: string
            maxLength: 255

    ProjectResult:
      properties:
        id:
          type: integer
        name:
          type: string
        objectives:
          type: string
        description:
          type: string
        funders:
          type: string
        budget:
          type: integer
        image:
          type: integer
          nullable: true
          description: the image id
        creation_date:
          type: string
          format: date-time
        last_modification:
          type: string
          format: date-time
        studies_count:
          type: integer
        tags:
          type: array
          items:
            type: string

    StudyUpsertRequest:
      properties:
        name:
          type: string
          maxLength: 128
        service_code:
          type: string
          maxLength: 128
        business_code:
          type: string
          maxLength: 128
        description:
          type: string
          maxLength: 1024
        budget:
          type: integer
        tags:
          type: array
          items:
            type: string
            maxLength: 255
        start_date:
          type: string
          nullable: true
          format: date-time
        expected_end_date:
          type: string
          nullable: true
          format: date-time
        actual_end_date:
          type: string
          nullable: true
          format: date-time
        state:
          type: string
          enum: ["started", "inProgress", "finish"]
        study_type:
          type: string
          enum:
            [
              "timeTables",
              "flowRate",
              "parkSizing",
              "garageRequirement",
              "operationOrSizing",
              "operability",
              "strategicPlanning",
              "chartStability",
              "disturbanceTests",
            ]
      required: [name, tags]

    StudyResult:
      properties:
        id:
          type: integer
        name:
          type: string
        project_id:
          type: integer
        description:
          type: string
        budget:
          type: integer
        tags:
          type: array
          items:
            type: string
        service_code:
          type: string
        business_code:
          type: string
        creation_date:
          type: string
          format: date-time
        last_modification:
          type: string
          format: date-time
        scenarios_count:
          type: integer
        start_date:
          type: string
          nullable: true
          format: date-time
        expected_end_date:
          type: string
          nullable: true
          format: date-time
        actual_end_date:
          type: string
          nullable: true
          format: date-time
        state:
          type: string
          enum: ["started", "inProgress", "finish"]
        study_type:
          type: string
          enum:
            [
              "timeTables",
              "flowRate",
              "parkSizing",
              "garageRequirement",
              "operationOrSizing",
              "operability",
              "strategicPlanning",
              "chartStability",
              "disturbanceTests",
            ]
      required:
        - id
        - name
        - project_id
        - description
        - budget
        - tags
        - service_code
        - business_code
        - creation_date
        - last_modification
        - scenarios_count
        - start_date
        - expected_end_date
        - actual_end_date

    ScenarioRequest:
      properties:
        name:
          type: string
          maxLength: 128
        description:
          type: string
          maxLength: 1024
        tags:
          type: array
          items:
            type: string
            maxLength: 255
        infra_id:
          type: integer
        electrical_profile_set_id:
          type: number
          description: Electrical profile set id (if any)
      required:
        - "name"
        - "infra_id"

    ScenarioPatchRequest:
      properties:
        name:
          type: string
          maxLength: 128
        description:
          type: string
          maxLength: 1024
        tags:
          type: array
          items:
            type: string
            maxLength: 255

    ScenarioResult:
      properties:
        id:
          type: integer
        name:
          type: string
        study_id:
          type: integer
        description:
          type: string
        tags:
          type: array
          items:
            type: string
        infra_id:
          type: integer
        infra_name:
          type: string
        electrical_profile_set_id:
          type: integer
          nullable: true
        electrical_profile_set_name:
          type: string
          nullable: true
        creation_date:
          type: string
          format: date-time
        last_modification:
          type: string
          format: date-time
        timetable_id:
          type: integer
        trains_count:
          type: integer
        trains_schedules:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
              train_name:
                type: string
              departure_time:
                type: string
              train_path:
                type: integer

    ScenarioListResult:
      properties:
        id:
          type: integer
        name:
          type: string
        study_id:
          type: integer
        description:
          type: string
        tags:
          type: array
          items:
            type: string
        infra_id:
          type: integer
        infra_name:
          type: string
        electrical_profile_set_id:
          type: integer
          nullable: true
        electrical_profile_set_name:
          type: string
          nullable: true
        creation_date:
          type: string
          format: date-time
        last_modification:
          type: string
          format: date-time
        timetable_id:
          type: integer
        trains_count:
          type: integer

    Point3D:
      type: array
      description: Point in 3D space
      minItems: 2
      maxItems: 3
      items:
        type: number

    Point:
      type: object
      description: GeoJSon geometry
      required:
        - type
        - coordinates
      properties:
        type:
          type: string
          enum:
            - Point
        coordinates:
          $ref: "#/components/schemas/Point3D"

    MultiPoint:
      type: object
      description: GeoJSon geometry
      required:
        - type
        - coordinates
      properties:
        type:
          type: string
          enum:
            - MultiPoint
        coordinates:
          type: array
          items:
            $ref: "#/components/schemas/Point3D"

    TrainSchedulePatch:
      type: object
      required: [id]
      properties:
        id:
          type: integer
        train_name:
          type: string
        rolling_stock_id:
          type: integer
        departure_time:
          type: number
          format: float
        path_id:
          type: integer
        initial_speed:
          type: number
          format: float
        labels:
          type: array
          items:
            type: string
        scheduled_points:
          type: array
          items:
            type: object
            required: [path_offset, time]
            properties:
              path_offset:
                type: number
                format: float
                description: Offset in meters from the start of the path at which the train must be.
              time:
                type: number
                format: float
                description: Time in seconds (elapsed since the train's departure) at which the train must be.
        allowances:
          type: array
          items:
            $ref: "#/components/schemas/Allowance"
        speed_limit_tags:
          description: Train category for speed limits
          type: string
        comfort:
          $ref: "#/components/schemas/Comfort"
        options:
          allOf:
            - $ref: "#/components/schemas/TrainScheduleOptions"
          nullable: true
        power_restriction_ranges:
          description: A list of ranges along the train path where power restrictions apply.
          type: array
          items:
            $ref: "#/components/schemas/PowerRestrictionRange"
          nullable: true
    TrainScheduleBatchItem:
      type: object
      required: [train_name, departure_time, initial_speed, rolling_stock_id]
      properties:
        train_name:
          type: string
        labels:
          type: array
          default: []
          items:
            type: string
        departure_time:
          type: number
          format: float
        initial_speed:
          type: number
          format: float
        allowances:
          default: []
          type: array
          items:
            $ref: "#/components/schemas/Allowance"
        scheduled_points:
          default: []
          type: array
          items:
            type: object
            required: [path_offset, time]
            properties:
              path_offset:
                type: number
                format: float
                description: Offset in meters from the start of the path at which the train must be.
              time:
                type: number
                format: float
                description: Time in seconds (elapsed since the train's departure) at which the train must be.
        comfort:
          $ref: "#/components/schemas/Comfort"
        speed_limit_tags:
          description: Train category for speed limits
          type: string
          nullable: true
        power_restriction_ranges:
          description: A list of ranges along the train path where power restrictions apply.
          type: array
          items:
            $ref: "#/components/schemas/PowerRestrictionRange"
          nullable: true
        options:
          allOf:
            - $ref: "#/components/schemas/TrainScheduleOptions"
          nullable: true
        rolling_stock_id:
          type: integer
    TrainSchedule:
      type: object
      properties:
        id:
          type: number
        train_name:
          type: string
        timetable_id:
          type: integer
        rolling_stock_id:
          type: integer
        departure_time:
          type: number
          format: float
        path_id:
          type: integer
        initial_speed:
          type: number
          format: float
        labels:
          type: array
          items:
            type: string
        scheduled_points:
          type: array
          items:
            type: object
            required: [path_offset, time]
            properties:
              path_offset:
                type: number
                format: float
                description: Offset in meters from the start of the path at which the train must be.
              time:
                type: number
                format: float
                description: Time in seconds (elapsed since the train's departure) at which the train must be.
        allowances:
          type: array
          items:
            $ref: "#/components/schemas/Allowance"
        speed_limit_tags:
          description: Train category for speed limits
          type: string
          nullable: true
        comfort:
          $ref: "#/components/schemas/Comfort"
        options:
          allOf:
            - $ref: "#/components/schemas/TrainScheduleOptions"
          nullable: true
        power_restriction_ranges:
          description: A list of ranges along the train path where power restrictions apply.
          type: array
          items:
            $ref: "#/components/schemas/PowerRestrictionRange"
          nullable: true
      required:
        - id
        - train_name
        - timetable_id
        - rolling_stock_id
        - departure_time
        - path_id
        - initial_speed
        - labels
        - scheduled_points
        - allowances
        - speed_limit_tags
        - comfort
        - options
        - power_restriction_ranges
    TimetableWithSchedulesDetails:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        train_schedule_summaries:
          type: array
          items:
            $ref: "#/components/schemas/TrainScheduleSummary"
      required:
        - id
        - name
        - train_schedule_summaries
    TrainScheduleSummary:
      allOf:
        - $ref: "#/components/schemas/TrainSchedule"
        - type: object
          properties:
            arrival_time:
              type: number
            mechanical_energy_consumed:
              type: object
              properties:
                base:
                  type: number
                eco:
                  type: number
                  nullable: true
              required: [base, eco]
            stops_count:
              type: integer
            path_length:
              type: integer
            invalid_reasons:
              type: array
              items:
                $ref: "#/components/schemas/InvalidTrainValues"
          required:
            - arrival_time
            - mechanical_energy_consumed
            - stops_count
            - path_length
            - invalid_reasons

    InvalidTrainValues:
      type: string
      enum:
        - NewerRollingStock
        - NewerInfra

    TrainScheduleOptions:
      description: Options for the standalone simulation
      type: object
      properties:
        ignore_electrical_profiles:
          type: boolean
          nullable: true

    RollingStockUsage:
      type: object
      properties:
        rolling_stock_id:
          type: integer
        usage:
          type: object
          properties:
            train_schedule_id:
              type: integer
            train_name:
              type: string
            project_id:
              type: integer
            project_name:
              type: string
            study_id:
              type: integer
            study_name:
              type: string
            scenario_id:
              type: integer
            scenario_name:
              type: string
          required:
            - train_schedule_id
            - train_name
            - project_id
            - project_name
            - study_id
            - study_name
            - scenario_id
            - scenario_name
      required:
        - rolling_stock_id
        - usage

    PowerRestrictionRange:
      description: A range along the train path where a power restriction is applied.
      type: object
      properties:
        begin_position:
          description: Offset from the start of the path, in meters.
          type: number
          format: float
        end_position:
          description: Offset from the start of the path, in meters.
          type: number
          format: float
        power_restriction_code:
          description: The power restriction code to apply.
          type: string
      example:
        begin_position: 0.0
        end_position: 1000.0
        power_restriction_code: "C1US"
      required: [begin_position, end_position, power_restriction_code]

    Allowance:
      oneOf:
        - $ref: "#/components/schemas/EngineeringAllowance"
        - $ref: "#/components/schemas/StandardAllowance"
      discriminator:
        propertyName: allowance_type

    StandardAllowance:
      properties:
        allowance_type:
          type: string
          enum: ["standard"]
        default_value:
          $ref: "#/components/schemas/AllowanceValue"
        ranges:
          type: array
          items:
            $ref: "#/components/schemas/RangeAllowance"
        distribution:
          type: string
          enum: ["MARECO", "LINEAR"]
        capacity_speed_limit:
          type: number
          format: double
          default: -1
      required: [allowance_type, default_value, ranges, distribution]

    EngineeringAllowance:
      allOf:
        - type: object
          properties:
            allowance_type:
              type: string
              enum: ["engineering"]
            distribution:
              type: string
              enum: ["MARECO", "LINEAR"]
            capacity_speed_limit:
              type: number
              format: double
              default: -1
          required: [allowance_type, distribution]
        - $ref: "#/components/schemas/RangeAllowance"

    RangeAllowance:
      properties:
        begin_position:
          type: number
        end_position:
          type: number
          example: 1000.0
        value:
          $ref: "#/components/schemas/AllowanceValue"
      required: [begin_position, end_position, value]

    AllowanceValue:
      oneOf:
        - $ref: "#/components/schemas/AllowanceTimePerDistanceValue"
        - $ref: "#/components/schemas/AllowanceTimeValue"
        - $ref: "#/components/schemas/AllowancePercentValue"
      discriminator:
        propertyName: value_type

    AllowanceTimePerDistanceValue:
      properties:
        value_type:
          type: string
          enum: ["time_per_distance"]
        minutes:
          type: number
          example: 5.0
          description: Minutes per 100k
      required: [value_type, minutes]

    AllowanceTimeValue:
      properties:
        value_type:
          type: string
          enum: ["time"]
        seconds:
          type: number
          example: 180.0
      required: [value_type, seconds]

    AllowancePercentValue:
      properties:
        value_type:
          type: string
          enum: ["percentage"]
        percentage:
          type: number
          example: 15.0
      required: [value_type, percentage]

    SimulationReportByTrain:
      properties:
        speeds:
          type: array
          minItems: 1
          items:
            allOf:
              - $ref: "#/components/schemas/SpaceTimePosition"
              - type: object
                properties:
                  speed:
                    type: number
                    format: float
                required: [speed]
        head_positions:
          type: array
          minItems: 1
          items:
            type: array
            minItems: 1
            items:
              $ref: "#/components/schemas/SpaceTimePosition"
        tail_positions:
          type: array
          minItems: 1
          items:
            type: array
            minItems: 1
            items:
              $ref: "#/components/schemas/SpaceTimePosition"
        stops:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                description: Can be null if it's not an operational point
                nullable: true
              name:
                type: string
                description: Can be 'Unknown' if it's not an operational point
              time: { type: number, format: float }
              position: { type: number, format: float }
              duration: { type: number, format: float }
              line_code: { type: number }
              track_number: { type: number }
              line_name: { type: string }
              track_name: { type: string }
            required:
              [
                id,
                name,
                time,
                position,
                duration,
                line_code,
                track_number,
                line_name,
                track_name,
              ]
        route_aspects:
          type: array
          items:
            type: object
            properties:
              signal_id:
                type: string
                description: id of the updated signal
              route_id:
                type: string
                description: id of the affected route on the train path
              time_start:
                type: number
                format: float
                description: the aspect starts being displayed at this time
              time_end:
                type: number
                format: float
                description: the aspect stops being displayed at this time
              position_start:
                type: number
                format: float
                description: the route starts at this position on the train path
              position_end:
                type: number
                format: float
                description: the route ends at this position on the train path
              color:
                type: number
                format: float
                description: color of the aspect (Bits 24-31 are alpha, 16-23 are red, 8-15 are green, 0-7 are blue)
              blinking:
                type: boolean
                description: true if the signal is blinking
              aspect_label:
                type: string
                description: label of the new signal aspect
            required:
              - signal_id
              - route_id
              - time_start
              - time_end
              - position_start
              - position_end
              - color
              - blinking
              - aspect_label
        signals:
          type: array
          items:
            type: object
            properties:
              signal_id: { type: integer }
              aspects:
                type: array
                items:
                  type: string
              geo_position:
                type: array
                items: { type: number, format: float }
                minItems: 2
                maxItems: 2
              schema_position:
                type: array
                items: { type: number, format: float }
                minItems: 2
                maxItems: 2
            required: [signal_id, aspects, geo_position, schema_position]
        mechanical_energy_consumed:
          type: number
          format: float
      required:
        - speeds
        - head_positions
        - tail_positions
        - stops
        - route_aspects
        - signals
        - mechanical_energy_consumed

    SpaceTimePosition:
      type: object
      properties:
        time: { type: number, format: float }
        position: { type: number, format: float }
      required: [time, position, speed]

    SimulationReport:
      properties:
        id:
          type: integer
        name:
          type: string
        labels:
          type: array
          items:
            type: string
        path:
          type: integer
          description: id of the path used for projection
        vmax:
          type: array
          minItems: 2
          items:
            type: object
            properties:
              position: { type: number }
              speed: { type: number }
            required: [position, speed]
        slopes:
          type: array
          minItems: 2
          items:
            type: object
            properties:
              position: { type: number }
              gradient: { type: number }
            required: [position, gradient]
        curves:
          type: array
          minItems: 2
          items:
            type: object
            properties:
              position: { type: number }
              radius: { type: number }
            required: [position, radius]
        base:
          $ref: "#/components/schemas/SimulationReportByTrain"
        eco:
          $ref: "#/components/schemas/SimulationReportByTrain"
        speed_limit_tags:
          type: string
        electrification_ranges:
          description: A list of ranges which should be contiguous and which describe the electrification on the path and if it is handled by the train
          type: array
          items:
            $ref: "#/components/schemas/ElectrificationRange"
          minItems: 1
        power_restriction_ranges:
          description: The list of ranges where power restrictions are applied
          type: array
          items:
            $ref: "#/components/schemas/PowerRestrictionRangeItem"

      required:
        - id
        - name
        - labels
        - path
        - vmax
        - slopes
        - curves
        - base
        - electrification_ranges
        - power_restriction_ranges

    PowerRestrictionRangeItem:
      properties:
        start:
          type: number
          format: double
        stop:
          type: number
          format: double
        code:
          type: string
        handled:
          type: boolean
      required: [start, stop, code, handled]

    ElectrificationRange:
      properties:
        start:
          type: number
          format: double
        stop:
          type: number
          format: double
        electrificationUsage:
          oneOf:
            - $ref: "#/components/schemas/Electrified"
            - $ref: "#/components/schemas/Neutral"
            - $ref: "#/components/schemas/NonElectrified"
          discriminator:
            propertyName: object_type
      required: [start, stop, is_electrified, electrificationUsage]

    Electrified:
      properties:
        mode:
          type: string
        mode_handled:
          type: boolean
        object_type:
          type: string
          enum: ["Electrified"]
        profile:
          type: string
          nullable: true
        profile_handled:
          type: boolean
      required: [mode, mode_handled, object_type, profile_handled]
    Neutral:
      properties:
        lower_pantograph:
          type: boolean
        object_type:
          type: string
          enum: ["Neutral"]
      required: [lower_pantograph, object_type]
    NonElectrified:
      properties:
        object_type:
          type: string
          enum: ["NonElectrified"]
      required: [object_type]

    Waypoint:
      type: array
      items:
        type: object
        properties:
          track_section:
            type: string
          geo_coordinate:
            type: array
            items: { type: number, format: float }
            minItems: 2
            maxItems: 2

    TimetableImportItem:
      properties:
        path:
          items:
            $ref: '#/components/schemas/TimetableImportPathStep'
          type: array
        rolling_stock:
          example: 2TGV2N2
          type: string
        trains:
          items:
            $ref: '#/components/schemas/TimetableImportTrain'
          type: array
      required:
      - rolling_stock
      - path
      - trains
      type: object

    TimetableImportPathSchedule:
      properties:
        arrival_time:
          format: date-time
          type: string
        departure_time:
          format: date-time
          type: string
      required:
      - arrival_time
      - departure_time
      type: object

    TimetableImportPathStep:
      properties:
        location:
          $ref: '#/components/schemas/TimetableImportPathLocation'
        schedule:
          additionalProperties:
            $ref: '#/components/schemas/TimetableImportPathSchedule'
          example:
            '7015':
              arrival_time: 2023-08-17T09:46:00+02:00
              departure_time: 2023-08-17T09:56:00+02:00
          type: object
      required:
      - location
      type: object

    TimetableImportPathLocation:
      discriminator:
        propertyName: type
      oneOf:
      - $ref: "#/components/schemas/TrackOffsetLocation"
      - $ref: "#/components/schemas/OperationalPointLocation"

    TimetableImportTrain:
      properties:
        departure_time:
          example: 2023-08-17T08:46:00+02:00
          format: date-time
          type: string
        name:
          example: '7015'
          type: string
      required:
      - name
      - departure_time
      type: object

    TrackOffsetLocation:
      properties:
        offset:
          format: double
          type: number
        track_section:
          type: string
        type:
          enum:
          - track_offset
          type: string
      required:
      - track_section
      - offset
      - type
      type: object

    OperationalPointLocation:
      properties:
        type:
          enum:
          - operational_point
          type: string
        uic:
          format: int64
          type: integer
      required:
      - uic
      - type
      type: object
